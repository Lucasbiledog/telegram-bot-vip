<script type="module">
  import { Web3Auth } from "https://cdn.jsdelivr.net/npm/@web3auth/modal/+esm";
  import { EthereumPrivateKeyProvider } from "https://cdn.jsdelivr.net/npm/@web3auth/ethereum-provider/+esm";

  // ... (restante inalterado)

  const ethRequest = async (conn, method, params=[]) => conn.request({ method, params });
  const toHex = (n) => "0x" + BigInt(n).toString(16);

  document.getElementById("connect").onclick = async () => {
    try {
      status.textContent = "Abrindo login Web3Auth...";
      await web3auth.initModal();
      const conn = await web3auth.connect();
      const userInfo = await web3auth.getUserInfo();
      const idToken = userInfo?.idToken;

      const [from] = await ethRequest(conn, "eth_accounts");
      const chainId = await ethRequest(conn, "eth_chainId");
      const to = document.getElementById("to").value.trim();
      const amount = document.getElementById("amount").value.trim();
      if (!from || !to || !amount) { status.textContent = "Preencha todos os campos."; return; }

      let txHash;
      if (document.getElementById("mode").value === "native") {
        const value = toHex(BigInt(Math.floor(parseFloat(amount) * 1e18)));
        txHash = await ethRequest(conn, "eth_sendTransaction", [ { from, to, value } ]);
      } else {
        const token = document.getElementById("token").value.trim();
        const decimals = Number(document.getElementById("decimals").value || 18);
        const methodSig = "0xa9059cbb"; // transfer(address,uint256)
        const pad = (hex, size=64) => hex.replace(/^0x/,"").padStart(size,"0");
        const toParam = pad(to);
        const amtRaw = BigInt(Math.floor(parseFloat(amount) * 10 ** decimals));
        const amtParam = pad("0x"+amtRaw.toString(16));
        const data = methodSig + toParam + amtParam;
        txHash = await ethRequest(conn, "eth_sendTransaction", [ { from, to: token, data } ]);
      }

      status.textContent = "Tx enviada. Confirmando... " + txHash;

      await fetch("/crypto_webhook", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          telegram_user_id: uid,
          tx_hash: txHash,
          chain_id: chainId,                 // <<<<<< ADICIONADO
          web3auth_id_token: idToken,
          link_sig: sig
        })
      });

      status.textContent = "Pagamento enviado! Você receberá o convite VIP pelo Telegram.";
      status.className = "ok";
    } catch (e) {
      console.error(e);
      status.textContent = "Erro: " + (e?.message || e);
      status.className = "err";
    }
  };
</script>
